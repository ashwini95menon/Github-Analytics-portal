from pydriller import RepositoryMining
import json
import csv
import datetime


class CommitsDrill:
    def __init__(self):
        self.urls = []

    @staticmethod
    def commits(urls):
        # urls = ["https://github.com/IBM/mi-prometheus", "https://github.com/AmeyaDhavalikar/BRep", "https://github.com/IBM/kui"]
        url_no = 1

        #open('data_gen/bugs_%s.csv' % name, 'w').close()
        #open('data_gen/bugs_%s.json' % name, 'w').close()

        for url in urls:
            count = 0
            commit_data = []
            name = url.split("/")[-1]
            for commit in RepositoryMining(url).traverse_commits():
                # commit_data.append([commit.hash, commit.project_name, commit.author.name, commit.Modification.filename, commit.author_date, commit.author_timezone, commit.branches, commit.committer_date])

                if "bug" in commit.msg:
                    #print("\tFixed a bug")
                    commit_data.append([commit.hash, commit.project_name, commit.author.name, len(commit.modifications), commit.author_timezone, commit.branches, commit.committer_date])
                    count += 1
            #print ("# of bugs fixed: ", count)

            myfile = open("data_gen/bugs_%s.csv" % name, "w")
            with myfile:
                writer = csv.writer(myfile)
                writer.writerows(commit_data)

            csvfile = open('data_gen/bugs_%s.csv' % name, 'r')
            jsonfile = open('data_gen/bugs_%s.json' % name, 'a')
            fieldnames = ("commit.hash", "commit.project_name", "commit.author.name", "len(commit.modifications)", "commit.author_timezone", "commit.branches", "commit.committer_date")
            reader = csv.DictReader(csvfile, fieldnames)
            for row in reader:
                json.dump(row, jsonfile)
                jsonfile.write('\n')
            url_no += 1
        myfile = open('cron_tab.txt','w')
        #myfile.write("CommitsDrill accessed on " + str(datetime.now()))
        return None


#if __name__ == "__main__":

#cd = CommitsDrill()
#cd.commits(["https://github.com/IBM/mi-prometheus", "https://github.com/AmeyaDhavalikar/BRep","https://github.com/IBM/kui"])
